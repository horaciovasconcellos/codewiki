# Scripts - Sistema de Auditoria

Esta pasta cont√©m os scripts de banco de dados e carga de dados do Sistema de Auditoria.

## üìÇ Estrutura de Arquivos

### Scripts SQL
- `create-tables.sql` - Cria√ß√£o de tabelas (MySQL)
- `create-contratos-tables.sql` - Tabelas de contratos
- `load-data.sql` - Carga inicial de dados (Oracle - legado)
- `fix-tecnologias.sql` - Corre√ß√µes em tecnologias
- `migrate-habilidades.sql` - Migra√ß√£o de habilidades
- `update-capacidades.sql` - Atualiza√ß√µes em capacidades

### Scripts de Carga (Bash + API REST)
- `load-tipos-afastamento.sh` - Carga de tipos de afastamento
- `load-habilidades.sh` - Carga de habilidades
- `load-capacidades-negocio.sh` - Carga de capacidades de neg√≥cio
- `load-colaboradores.sh` - Carga de colaboradores
- `load-tecnologias.sh` - Carga de tecnologias
- `load-processos.sh` - Carga de processos de neg√≥cio
- `load-slas.sh` - Carga de SLAs
- `load-aplicacoes.sh` - Carga de aplica√ß√µes
- `import-tecnologias-pom.sh` - **[NOVO]** Importa tecnologias de arquivo pom.xml Maven

### Scripts de Migra√ß√£o
- `migrate-habilidades.sh` - Migra√ß√£o de estrutura de habilidades
- `load-habilidades.js` - Carga via Node.js (alternativa)

### Scripts de Manuten√ß√£o
- `backup-mysql.sh` - Backup do MySQL
- `restore-mysql.sh` - Restaura√ß√£o do MySQL
- `check-db-structure.sh` - Verifica√ß√£o de estrutura
- `diagnose-server.sh` - Diagn√≥stico do servidor
- `full-diagnostic.sh` - Diagn√≥stico completo

### Scripts de Teste
- `test-criar-tipo-afastamento.sh` - Teste de cria√ß√£o
- `test-habilidades.sh` - Teste de habilidades
- `test-single-habilidade.sh` - Teste unit√°rio

### Utilit√°rios
- `export-data.sh` - Exporta√ß√£o de dados
- `load-data.sh` - Carga gen√©rica (legado)

## üìö Arquivos de Documenta√ß√£o

- `README.md` - Este arquivo
- `README-CARGA-HABILIDADES.md` - Guia de carga de habilidades
- `README_MIGRACAO_HABILIDADES.md` - Guia de migra√ß√£o

## Arquivos Dispon√≠veis

### 1. `create-tables.sql`
Script de cria√ß√£o de todas as tabelas do sistema.

**Tabelas criadas:**
- `tipos_afastamento` - Tipos de afastamento de colaboradores
- `colaboradores` - Cadastro de colaboradores
- `afastamentos` - Registro de afastamentos
- `tecnologias` - Cadastro de tecnologias
- `processos_negocio` - Processos de neg√≥cio
- `aplicacoes` - Aplica√ß√µes do sistema
- `capacidades_negocio` - Capacidades de neg√≥cio
- `slas` - Service Level Agreements
- `runbooks` - Runbooks operacionais
- `habilidades` - Habilidades t√©cnicas e comportamentais
- `habilidades_colaboradores` - Associa√ß√£o de habilidades aos colaboradores
- `repositorios_projetos` - Reposit√≥rios de projetos (com campo calculado)
- `projetos_gerados` - Hist√≥rico de projetos gerados
- `repos_por_projeto` - Associa√ß√£o de reposit√≥rios aos projetos
- `tokens_acesso` - Tokens de acesso para APIs
- `tokens_escopos` - Escopos dos tokens
- `tokens_origens` - Origens permitidas para os tokens

**Caracter√≠sticas:**
- Todas as tabelas incluem constraints de chave prim√°ria e estrangeira
- √çndices para otimiza√ß√£o de performance
- Coment√°rios em tabelas e colunas
- Campo calculado (VIRTUAL) para `nome_repositorio` = `produto-categoria-tecnologia`

### 2. `load-data.sql`
Script de carga inicial de dados para popular as tabelas com informa√ß√µes de exemplo.

**Dados inclu√≠dos:**
- 5 tipos de afastamento
- 10 habilidades
- 3 capacidades de neg√≥cio
- 5 aplica√ß√µes (SISAUD, PORTAL, FINANCE, RHUMANO, ANALITICA)
- 5 tecnologias
- 3 processos de neg√≥cio
- 3 SLAs
- 3 runbooks
- 1 colaborador de exemplo (matr√≠cula 5664)
- 3 habilidades do colaborador
- 9 reposit√≥rios de exemplo
- 1 projeto gerado de exemplo
- 1 token de acesso de exemplo

## Como Executar

### Op√ß√£o 1: SQL*Plus (Oracle)
```bash
# Conectar ao banco de dados
sqlplus usuario/senha@banco

# Executar script de cria√ß√£o
@create-tables.sql

# Executar script de carga
@load-data.sql
```

### Op√ß√£o 2: SQL Developer
1. Abra o SQL Developer
2. Conecte-se ao banco de dados
3. Abra o arquivo `create-tables.sql`
4. Execute o script (F5 ou bot√£o Run Script)
5. Abra o arquivo `load-data.sql`
6. Execute o script (F5 ou bot√£o Run Script)

### Op√ß√£o 3: Linha de Comando
```bash
# Executar script de cria√ß√£o
sqlplus usuario/senha@banco @create-tables.sql

# Executar script de carga
sqlplus usuario/senha@banco @load-data.sql
```

## Ordem de Execu√ß√£o

**IMPORTANTE:** Execute os scripts na seguinte ordem:

1. **Primeiro:** `create-tables.sql` - Cria todas as estruturas
2. **Depois:** `load-data.sql` - Popula as tabelas com dados

## Campo Calculado - Nome do Reposit√≥rio

A tabela `repositorios_projetos` possui um campo calculado que concatena automaticamente:

```
nome_repositorio = produto + '-' + categoria + '-' + tecnologia
```

**Exemplos:**
- Produto: `SISAUD`, Categoria: `backend`, Tecnologia: `java` ‚Üí `SISAUD-backend-java`
- Produto: `PORTAL`, Categoria: `frontend`, Tecnologia: `angular` ‚Üí `PORTAL-frontend-angular`
- Produto: `FINANCE`, Categoria: `api`, Tecnologia: `java` ‚Üí `FINANCE-api-java`

Este campo √© **VIRTUAL** (calculado automaticamente) e n√£o pode ser inserido ou atualizado manualmente.

## Valida√ß√µes e Regras

### Tipos de Afastamento
- `tipo_tempo`: Aceita apenas 'C' (Corrido) ou 'N' (N√£o corrido)

### Tokens de Acesso
- `status`: Ativo, Revogado, Expirado, Pendente, Suspenso
- `ambiente`: Produ√ß√£o, Homologa√ß√£o, Desenvolvimento
- `tipo_entidade`: Pessoa F√≠sica, Pessoa Jur√≠dica, Sistema, Servi√ßo Interno

### Reposit√≥rios
- Combina√ß√£o √∫nica de produto + categoria + tecnologia

### Aplica√ß√µes
- Siglas √∫nicas (constraint `uk_aplicacoes_sigla`)

## Categorias de Reposit√≥rio

Valores aceitos para o campo `categoria`:
- analiticos
- api
- app
- batch
- dashboard
- etl
- frontend
- backend
- integracao
- portal
- svc

## Tecnologias de Reposit√≥rio

Valores aceitos para o campo `tecnologia`:
- airflow
- angular
- databricks
- go
- java
- kotlin
- mulesoft
- node
- php
- plsql
- powerbi
- python
- react
- spark
- ords

## Verifica√ß√£o de Carga

Ap√≥s executar o script de carga, voc√™ ver√° um resumo com a quantidade de registros em cada tabela:

```
TABELA                          REGISTROS
------------------------------ ----------
Aplica√ß√µes                              5
Capacidades de Neg√≥cio                  3
Colaboradores                           1
Habilidades                            10
Habilidades Colaboradores               3
Processos de Neg√≥cio                    3
Projetos Gerados                        1
Reposit√≥rios de Projetos                9
Reposit√≥rios por Projeto                3
Runbooks                                3
SLAs                                    3
Tecnologias                             5
Tipos de Afastamento                    5
Tokens Escopos                          2
Tokens Origens                          2
Tokens de Acesso                        1
```

## Limpeza de Dados

Para remover todos os dados e estruturas:

```sql
-- ATEN√á√ÉO: Este comando apaga TODOS os dados!
DROP TABLE tokens_origens CASCADE CONSTRAINTS;
DROP TABLE tokens_escopos CASCADE CONSTRAINTS;
DROP TABLE tokens_acesso CASCADE CONSTRAINTS;
DROP TABLE repos_por_projeto CASCADE CONSTRAINTS;
DROP TABLE projetos_gerados CASCADE CONSTRAINTS;
DROP TABLE repositorios_projetos CASCADE CONSTRAINTS;
DROP TABLE habilidades_colaboradores CASCADE CONSTRAINTS;
DROP TABLE habilidades CASCADE CONSTRAINTS;
DROP TABLE runbooks CASCADE CONSTRAINTS;
DROP TABLE slas CASCADE CONSTRAINTS;
DROP TABLE capacidades_negocio CASCADE CONSTRAINTS;
DROP TABLE aplicacoes CASCADE CONSTRAINTS;
DROP TABLE processos_negocio CASCADE CONSTRAINTS;
DROP TABLE tecnologias CASCADE CONSTRAINTS;
DROP TABLE afastamentos CASCADE CONSTRAINTS;
DROP TABLE colaboradores CASCADE CONSTRAINTS;
DROP TABLE tipos_afastamento CASCADE CONSTRAINTS;
```

## Scripts de Carga via API REST

Os scripts de carga utilizam a API REST do sistema para popular o banco de dados. Todos seguem o mesmo padr√£o:

### Padr√£o de Nomenclatura

```bash
load-{entidade}.sh
```

Exemplos:
- `load-tipos-afastamento.sh`
- `load-habilidades.sh`
- `load-capacidades-negocio.sh`
- `load-colaboradores.sh`
- `load-tecnologias.sh`
- `load-processos.sh`
- `load-slas.sh`
- `load-aplicacoes.sh`

### Como Usar os Scripts de Carga

```bash
# 1. Tornar execut√°vel (apenas primeira vez)
chmod +x load-tipos-afastamento.sh

# 2. Executar (arquivo padr√£o em data-templates/)
./load-tipos-afastamento.sh

# 3. OU especificar arquivo customizado
./load-tipos-afastamento.sh meus-tipos.json
```

### Pr√©-requisitos

1. **jq** instalado:
   ```bash
   # macOS
   brew install jq
   
   # Linux
   sudo apt-get install jq
   ```

2. **Servidor rodando**:
   ```bash
   # Op√ß√£o 1: Docker
   docker-compose up
   
   # Op√ß√£o 2: Local
   npm run dev
   ```

3. **Arquivo de dados** em `data-templates/`:
   - `tipos-afastamento.json`
   - `habilidades.json`
   - `capacidades-negocio.json`
   - `colaboradores.json`
   - etc.

### Estrutura dos Scripts

Todos os scripts seguem o mesmo padr√£o:

1. **Valida√ß√£o**:
   - Verificar se arquivo existe
   - Validar JSON
   - Verificar se servidor est√° rodando

2. **Confirma√ß√£o**:
   - Mostrar total de registros
   - Pedir confirma√ß√£o do usu√°rio

3. **Processamento**:
   - Verificar se registro j√° existe
   - Se existe: atualizar (PUT)
   - Se n√£o existe: criar (POST)
   - Logar cada opera√ß√£o

4. **Resumo**:
   - Criados
   - Atualizados
   - Duplicados
   - Erros
   - Total no banco

### Exemplo de Sa√≠da

```
==========================================
CARGA DE TIPOS DE AFASTAMENTO
==========================================

üìÑ Arquivo: ../data-templates/tipos-afastamento.json

üîç Verificando servidor...
‚úì Servidor OK

üîç Validando arquivo JSON...
‚úì JSON v√°lido

üìä Total de tipos de afastamento a processar: 12

Deseja continuar com a carga? (s/N) s

==========================================
PROCESSANDO REGISTROS
==========================================

Processando: FER - F√©rias
  ‚úì Criado (ID: 550e8400-e29b-41d4-a716-446655440001)

Processando: LIC-MED - Licen√ßa M√©dica
  ‚Üª Atualizado (ID: 550e8400-e29b-41d4-a716-446655440002)

==========================================
RESUMO DA CARGA
==========================================
‚úì Criados:      8
‚Üª Atualizados:  3
‚ö† Duplicados:   1
‚úó Erros:        0
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Total:        12

üîç Verificando registros no banco...
‚úì Total de tipos de afastamento no banco: 12

‚úì Carga conclu√≠da!
```

### Logs

Cada execu√ß√£o gera um arquivo de log:

```
load-tipos-afastamento-20251125_103045.log
load-habilidades-20251125_103145.log
load-capacidades-20251123_124914.log
```

Os logs cont√™m:
- Data/hora de in√≠cio
- Erros detalhados (se houver)
- Mensagens de aviso

### Ordem Recomendada de Carga

1. `load-tipos-afastamento.sh` - Tipos de afastamento (sem depend√™ncias)
2. `load-habilidades.sh` - Habilidades (sem depend√™ncias)
3. `load-capacidades-negocio.sh` - Capacidades (sem depend√™ncias)
4. `load-tecnologias.sh` - Tecnologias (sem depend√™ncias)
5. `load-processos.sh` - Processos (sem depend√™ncias)
6. `load-slas.sh` - SLAs (sem depend√™ncias)
7. `load-colaboradores.sh` - Colaboradores (depende de tipos-afastamento e habilidades)
8. `load-aplicacoes.sh` - Aplica√ß√µes (depende de tecnologias, capacidades, processos, SLAs)

### Carga Completa (Todos os Dados)

```bash
#!/bin/bash
# Script para carga completa de todos os dados

echo "üöÄ Iniciando carga completa..."

./load-tipos-afastamento.sh
./load-habilidades.sh
./load-capacidades-negocio.sh
./load-tecnologias.sh
./load-processos.sh
./load-slas.sh
./load-colaboradores.sh
./load-aplicacoes.sh

echo "‚úÖ Carga completa conclu√≠da!"
```

### Troubleshooting

**Erro: "jq n√£o est√° instalado"**
```bash
brew install jq
```

**Erro: "Servidor n√£o est√° respondendo"**
```bash
# Verificar se servidor est√° rodando
curl http://localhost:3000/health

# Iniciar servidor
docker-compose up
# OU
npm run dev
```

**Erro: "Arquivo JSON inv√°lido"**
```bash
# Validar JSON manualmente
jq empty data-templates/tipos-afastamento.json
```

**Erro: "Permission denied"**
```bash
# Tornar script execut√°vel
chmod +x load-tipos-afastamento.sh
```

---

## üîß Script de Importa√ß√£o de Tecnologias Maven

### `import-tecnologias-pom.sh`

Script que extrai depend√™ncias e plugins de um arquivo `pom.xml` Maven e cadastra automaticamente no sistema de auditoria via API REST.

#### Pr√©-requisitos

```bash
# macOS
brew install libxml2 jq

# Linux (Ubuntu/Debian)
sudo apt-get install libxml2-utils jq

# Linux (CentOS/RHEL)
sudo yum install libxml2 jq
```

#### Uso

```bash
# Sintaxe b√°sica
./import-tecnologias-pom.sh <caminho-do-pom.xml> [URL_API]

# Exemplos
./import-tecnologias-pom.sh exemplo-pom.xml
./import-tecnologias-pom.sh /path/to/projeto/pom.xml
./import-tecnologias-pom.sh ~/projetos/meu-app/pom.xml http://localhost:3000/api
```

#### Funcionalidades

- ‚úÖ Extrai **depend√™ncias** do pom.xml
- ‚úÖ Extrai **plugins** de build
- ‚úÖ Resolve **propriedades** Maven (ex: `${spring.boot.version}`)
- ‚úÖ Categoriza automaticamente (Framework, ORM, Database, Testing, etc.)
- ‚úÖ Identifica tipo baseado no scope (test, runtime, provided)
- ‚úÖ Cadastra via API REST
- ‚úÖ Log colorido com resumo de importa√ß√£o
- ‚úÖ Tratamento de erros e duplicadas

#### Exemplo de Output

```
[INFO] ======================================================
[INFO] Importando tecnologias do pom.xml
[INFO] ======================================================
[INFO] Arquivo: exemplo-pom.xml
[INFO] API URL: http://localhost:3000/api
[INFO] 
[INFO] Projeto: com.exemplo:minha-aplicacao:1.0.0
[INFO] 
[INFO] Extraindo depend√™ncias...
[INFO] 
[SUCCESS] ‚úì org.springframework.boot:spring-boot-starter-web 3.2.0 cadastrada
[SUCCESS] ‚úì org.springframework.boot:spring-boot-starter-data-jpa 3.2.0 cadastrada
[SUCCESS] ‚úì com.mysql:mysql-connector-j 8.2.0 cadastrada
[SUCCESS] ‚úì org.liquibase:liquibase-core 4.25.0 cadastrada
[WARNING] ‚ö† org.projectlombok:lombok 1.18.30 - HTTP 409: J√° existe
[INFO] 
[INFO] ======================================================
[INFO] Resumo da Importa√ß√£o
[INFO] ======================================================
[INFO] Total de tecnologias: 10
[SUCCESS] Cadastradas com sucesso: 8
[WARNING] Falhas/Duplicadas: 2
[INFO] ======================================================
```

#### Categoriza√ß√£o Autom√°tica

| GroupId Pattern | Categoria | Exemplos |
|----------------|-----------|----------|
| `org.springframework.*` | Framework | Spring Boot, Spring Data |
| `org.hibernate.*` | ORM | Hibernate Core, Validator |
| `com.mysql.*`, `org.postgresql.*` | Database Driver | MySQL, PostgreSQL |
| `junit.*`, `org.mockito.*` | Testing | JUnit, Mockito |
| `org.slf4j.*`, `ch.qos.logback.*` | Logging | SLF4J, Logback |
| `com.fasterxml.*`, `com.google.code.gson.*` | JSON | Jackson, Gson |
| `org.liquibase.*`, `org.flywaydb.*` | Database Migration | Liquibase, Flyway |
| `javax.*`, `jakarta.*` | Java EE | Servlet, Validation |
| Outros | Library | Demais depend√™ncias |

#### Arquivo de Exemplo

Um arquivo `exemplo-pom.xml` est√° inclu√≠do para testes:

```bash
./import-tecnologias-pom.sh exemplo-pom.xml
```

---

## Suporte

Para d√∫vidas ou problemas relacionados aos scripts, entre em contato com a equipe de desenvolvimento.
