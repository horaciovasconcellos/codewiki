name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false
        continue-on-error: true

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) origin/${{ github.base_ref }} HEAD | grep -q "<<<<<"; then
            echo "‚ùå Merge conflicts detected"
            exit 1
          fi
          echo "‚úÖ No merge conflicts"

      - name: Check file sizes
        run: |
          large_files=$(find . -type f -size +5M -not -path '*/node_modules/*' -not -path '*/.git/*' -not -path '*/dist/*' -not -path '*/build/*' || true)
          if [ -n "$large_files" ]; then
            echo "‚ö†Ô∏è  Large files detected (>5MB):"
            echo "$large_files"
            echo "Consider using Git LFS for large files"
          else
            echo "‚úÖ No large files detected"
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check code formatting
        run: |
          # Check for common formatting issues
          echo "Checking for trailing whitespaces..."
          ! git diff --check || echo "‚ö†Ô∏è  Trailing whitespaces found"
          
          echo "Checking for TODO/FIXME comments..."
          todos=$(grep -r "TODO\|FIXME" server/src/ --exclude-dir=node_modules || true)
          if [ -n "$todos" ]; then
            echo "‚ö†Ô∏è  Found TODO/FIXME comments:"
            echo "$todos"
          fi

      - name: Check dependencies
        run: |
          echo "Checking for duplicate dependencies..."
          npm ls --depth=0 || true
          
          echo "Checking for outdated dependencies..."
          npm outdated || true

      - name: Run complexity analysis
        run: |
          echo "Analyzing code complexity..."
          find server/src -name "*.js" -type f | while read file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 500 ]; then
              echo "‚ö†Ô∏è  Large file detected: $file ($lines lines)"
            fi
          done

  changelog:
    name: Changelog Check
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changelog update
        run: |
          if [ -f "CHANGELOG.md" ]; then
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
              echo "‚úÖ CHANGELOG.md updated"
            else
              echo "‚ö†Ô∏è  CHANGELOG.md not updated"
              echo "Consider updating CHANGELOG.md for significant changes"
            fi
          else
            echo "‚ÑπÔ∏è  No CHANGELOG.md found"
          fi

  commit-messages:
    name: Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "Checking commit messages..."
          git log --format=%B origin/${{ github.base_ref }}..HEAD | while read -r line; do
            if [ -n "$line" ]; then
              length=${#line}
              if [ "$length" -gt 100 ]; then
                echo "‚ö†Ô∏è  Long commit message line (>100 chars): $line"
              fi
            fi
          done
          echo "‚úÖ Commit messages checked"

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpass123
          MYSQL_DATABASE: auditoria_db_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: testpass123
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        env:
          NODE_ENV: test
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_USER: test_user
          MYSQL_PASSWORD: testpass123
          MYSQL_DATABASE: auditoria_db_test
          JWT_SECRET: test-secret-key
        run: npm run test:coverage || true
        continue-on-error: true

      - name: Comment coverage on PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: always()
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: http://localhost:3000

      - name: Check bundle size
        run: |
          if [ -d "dist" ]; then
            echo "üì¶ Bundle size analysis:"
            du -sh dist/
            find dist/ -name "*.js" -exec ls -lh {} \; | awk '{if ($5 ~ /M/ && $5+0 > 1) print "‚ö†Ô∏è  Large JS file:", $9, "(" $5 ")"}'
            find dist/ -name "*.css" -exec ls -lh {} \; | awk '{if ($5 ~ /M/ && $5+0 > 1) print "‚ö†Ô∏è  Large CSS file:", $9, "(" $5 ")"}'
          fi
